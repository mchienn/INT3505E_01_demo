openapi: 3.0.0
info:
  title: JWT Authentication API with Product CRUD
  version: 2.0.0
  description: |

servers:
  - url: http://localhost:5000
    description: Development server

tags:
  - name: Authentication
    description: User authentication and token management
  - name: Products
    description: Product CRUD operations

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token obtained from /auth/login or /auth/refresh

  schemas:
    User:
      type: object
      properties:
        user_id:
          type: integer
          example: 1
        username:
          type: string
          example: "user1"
        email:
          type: string
          format: email
          example: "user1@example.com"
        full_name:
          type: string
          example: "John Doe"
        role:
          type: string
          enum: [admin, user]
          example: "user"
        is_active:
          type: boolean
          example: true
        created_at:
          type: string
          format: date-time
          example: "2024-01-15T00:00:00"

    Product:
      type: object
      properties:
        product_id:
          type: integer
          example: 1
        name:
          type: string
          example: "Laptop Dell XPS 15"
        description:
          type: string
          example: "High-performance laptop with 16GB RAM"
        price:
          type: number
          format: float
          example: 1299.99
        category:
          type: string
          example: "Electronics"
        stock:
          type: integer
          example: 50
        created_by:
          type: integer
          example: 1
        created_at:
          type: string
          format: date-time
          example: "2024-11-05T10:00:00"
        updated_at:
          type: string
          format: date-time
          example: "2024-11-05T10:00:00"

    LoginRequest:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
          example: "user1"
        password:
          type: string
          format: password
          example: "user123"

    LoginResponse:
      type: object
      properties:
        message:
          type: string
          example: "Login successful"
        access_token:
          type: string
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        refresh_token:
          type: string
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        token_type:
          type: string
          example: "Bearer"
        expires_in:
          type: integer
          example: 900
        user:
          $ref: "#/components/schemas/User"

    Error:
      type: object
      properties:
        error:
          type: string
          example: "Invalid credentials"

paths:
  # Authentication endpoints
  /auth/login:
    post:
      tags:
        - Authentication
      summary: User login
      description: Authenticate user and receive access & refresh tokens
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /auth/register:
    post:
      tags:
        - Authentication
      summary: Register new user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
                - email
                - full_name
              properties:
                username:
                  type: string
                  example: "newuser"
                password:
                  type: string
                  format: password
                  example: "SecurePass123"
                email:
                  type: string
                  format: email
                  example: "newuser@example.com"
                full_name:
                  type: string
                  example: "New User"
      responses:
        "201":
          description: User registered successfully
        "400":
          description: Validation error
        "409":
          description: Username already exists

  /auth/refresh:
    post:
      tags:
        - Authentication
      summary: Refresh access token
      description: Exchange refresh token for new access & refresh tokens (rotation)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refresh_token
              properties:
                refresh_token:
                  type: string
      responses:
        "200":
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  access_token:
                    type: string
                  refresh_token:
                    type: string
                  token_type:
                    type: string
                  expires_in:
                    type: integer
        "401":
          description: Invalid or expired refresh token

  /auth/logout:
    post:
      tags:
        - Authentication
      summary: Logout user
      security:
        - BearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                refresh_token:
                  type: string
                  description: Optional refresh token to revoke
      responses:
        "200":
          description: Logged out successfully
        "401":
          description: Unauthorized

  /auth/me:
    get:
      tags:
        - Authentication
      summary: Get current user profile
      security:
        - BearerAuth: []
      responses:
        "200":
          description: User profile
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: "#/components/schemas/User"
        "401":
          description: Unauthorized

  /auth/change-password:
    post:
      tags:
        - Authentication
      summary: Change password
      description: Change password for authenticated user
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - old_password
                - new_password
              properties:
                old_password:
                  type: string
                  format: password
                new_password:
                  type: string
                  format: password
      responses:
        "200":
          description: Password changed successfully
        "400":
          description: Validation error
        "401":
          description: Invalid old password

  # Product endpoints
  /api/products:
    get:
      tags:
        - Products
      summary: Get all products
      description: Retrieve list of all products (public endpoint)
      parameters:
        - name: category
          in: query
          schema:
            type: string
          description: Filter by category
        - name: min_price
          in: query
          schema:
            type: number
          description: Minimum price filter
        - name: max_price
          in: query
          schema:
            type: number
          description: Maximum price filter
      responses:
        "200":
          description: List of products
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                    example: 10
                  products:
                    type: array
                    items:
                      $ref: "#/components/schemas/Product"

    post:
      tags:
        - Products
      summary: Create new product
      description: Create a new product (requires authentication)
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - price
                - category
              properties:
                name:
                  type: string
                  example: "Laptop Dell XPS 15"
                description:
                  type: string
                  example: "High-performance laptop"
                price:
                  type: number
                  format: float
                  example: 1299.99
                category:
                  type: string
                  example: "Electronics"
                stock:
                  type: integer
                  example: 50
      responses:
        "201":
          description: Product created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Product created successfully"
                  product:
                    $ref: "#/components/schemas/Product"
        "400":
          description: Validation error
        "401":
          description: Unauthorized

  /api/products/{product_id}:
    get:
      tags:
        - Products
      summary: Get product by ID
      description: Retrieve a specific product by its ID
      parameters:
        - name: product_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Product details
          content:
            application/json:
              schema:
                type: object
                properties:
                  product:
                    $ref: "#/components/schemas/Product"
        "404":
          description: Product not found

    put:
      tags:
        - Products
      summary: Update product
      description: Update an existing product (owner or admin only)
      security:
        - BearerAuth: []
      parameters:
        - name: product_id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                description:
                  type: string
                price:
                  type: number
                category:
                  type: string
                stock:
                  type: integer
      responses:
        "200":
          description: Product updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  product:
                    $ref: "#/components/schemas/Product"
        "401":
          description: Unauthorized
        "403":
          description: Forbidden - not product owner
        "404":
          description: Product not found

    delete:
      tags:
        - Products
      summary: Delete product
      description: Delete a product (owner or admin only)
      security:
        - BearerAuth: []
      parameters:
        - name: product_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Product deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  deleted_product:
                    type: object
                    properties:
                      product_id:
                        type: integer
                      name:
                        type: string
        "401":
          description: Unauthorized
        "403":
          description: Forbidden - not product owner
        "404":
          description: Product not found
